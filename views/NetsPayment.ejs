<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NETS QR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Bootstrap CSS (required for navbar styling) -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >

  <!-- NETS SSE polyfill -->
  <script src="https://unpkg.com/event-source-polyfill"></script>

  <!-- ✅ YOUR NAVBAR COLOR (as requested) -->
  <style>
    .app-navbar {
      background: linear-gradient(
        to bottom,
        #0b4f8a,
        #083b6f
      );
    }
  </style>
</head>

<body>
  <!-- ✅ NAVBAR PARTIAL -->
  <%- include('partials/navbar', { active: 'orders', user: user }) %>

  <!-- Page content -->
  <div class="container my-4">
    <h1 class="mb-2">Scan the QR Code</h1>
    <p id="status" class="text-muted">
      Scan with your T-wallet / bank app to complete payment
    </p>

    <% if (qrCodeUrl && qrCodeUrl.length) { %>
      <img
        src="<%= qrCodeUrl %>"
        alt="QR Code"
        class="img-fluid border rounded p-3 bg-white"
        style="max-width:360px;"
      />
    <% } else { %>
      <p class="text-danger">QR code not available. Please try again.</p>
    <% } %>

    <p id="timer" class="mt-3 fw-semibold">
      Time remaining: 5:00
    </p>

    <a
      href="/payments/nets/fail?orderId=<%= order.id %>"
      class="btn btn-outline-danger mt-2"
    >
      Cancel
    </a>
  </div>

  <!-- ✅ FOOTER PARTIAL -->
  <%- include('partials/footer') %>

  <!-- Bootstrap JS (for navbar toggler on mobile) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- ================= NETS LOGIC (UNCHANGED) ================= -->
  <script>
    let s2sNetsTxnStatus;

    if (s2sNetsTxnStatus) {
      s2sNetsTxnStatus.close();
    }

    const txnRetrievalRef = "<%= txnRetrievalRef %>";
    const url = `/sse/nets/payment-status/${txnRetrievalRef}`;

    s2sNetsTxnStatus = new EventSourcePolyfill(url, {
      heartbeatTimeout: 150000,
    });

    s2sNetsTxnStatus.addEventListener("message", (event) => {
      const data = JSON.parse(event.data);
      console.log("NETS Query Response:", data);

      if (data.success) {
        if (s2sNetsTxnStatus) s2sNetsTxnStatus.close();
        window.location.href =
          `/payments/nets/success?txn=${encodeURIComponent(txnRetrievalRef)}`;
      } else if (data.fail) {
        if (s2sNetsTxnStatus) s2sNetsTxnStatus.close();
        window.location.href =
          `/payments/nets/fail?orderId=<%= order.id %>`;
      }
    });

    // Countdown Timer (5 minutes)
    const timerElement = document.getElementById("timer");
    let remainingTime = 300;

    const updateTimer = () => {
      const minutes = Math.floor(remainingTime / 60);
      const seconds = remainingTime % 60;
      timerElement.textContent =
        `Time remaining: ${minutes}:${seconds.toString().padStart(2, "0")}`;
      remainingTime--;

      if (remainingTime < 0) {
        clearInterval(timerInterval);
        timerElement.textContent = "Transaction timed out.";

        if (s2sNetsTxnStatus) {
          s2sNetsTxnStatus.close();
        }
        window.location.href =
          `/payments/nets/fail?orderId=<%= order.id %>`;
      }
    };

    const timerInterval = setInterval(updateTimer, 1000);
    updateTimer();
  </script>
</body>
</html>
