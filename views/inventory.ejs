<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Inventory – Supermarket Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Bootstrap + app.css -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/app.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Small tweaks for the product cards -->
  <style>
    .product-card-img {
      max-height: 140px;
      object-fit: contain;
    }
    .product-card-price {
      font-size: 1.1rem;
      font-weight: 600;
    }
  </style>
</head>
<body class="bg-page">
  <%- include('partials/admin-modern-navbar', { user: user, active: 'inventory' }) %>

  <main class="app-main">
    <div class="container-fluid">
      <!-- Header row -->
      <div class="row align-items-center mb-3">
        <div class="col-md-6">
          <h2 class="mb-1">Inventory</h2>
          <p class="text-muted mb-0">
            Manage all products in the supermarket database.
          </p>
        </div>
        <div class="col-md-6 text-md-end mt-3 mt-md-0">
          <a href="/addProduct" class="btn btn-primary me-2">+ Add Product</a>
          <a href="/" class="btn btn-outline-secondary">Back to Home</a>
        </div>
      </div>

      <!-- Stats cards -->
      <div class="row g-3 mb-4">
        <div class="col-sm-6 col-lg-3">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="text-muted text-uppercase small mb-1">Total Items</div>
              <div class="h4 mb-0"><%= (products || []).length %></div>
            </div>
          </div>
        </div>

        <div class="col-sm-6 col-lg-3">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="text-muted text-uppercase small mb-1">Total Quantity</div>
              <div class="h4 mb-0">
                <%= (products || []).reduce((sum, p) => sum + (p.quantity || 0), 0) %>
              </div>
            </div>
          </div>
        </div>

        <div class="col-sm-6 col-lg-3">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="text-muted text-uppercase small mb-1">Average Price</div>
              <div class="h4 mb-0">
                <% 
                  const count = (products || []).length || 1;
                  const avgPrice = (products || []).reduce((sum, p) => sum + (p.price || 0), 0) / count;
                %>
                $<%= avgPrice.toFixed(2) %>
              </div>
            </div>
          </div>
        </div>

        <div class="col-sm-6 col-lg-3">
          <div class="card shadow-sm">
            <div class="card-body">
              <div class="text-muted text-uppercase small mb-1">Logged in</div>
              <div class="h6 mb-0">
                <%= user && user.username ? user.username : 'Admin' %>
                <span class="badge bg-danger ms-2">Admin</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Filters + Sort -->
      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <div class="row g-2">
            <div class="col-md-4">
              <label for="productSearch" class="form-label small text-muted mb-1">Search</label>
              <input id="productSearch" type="text" class="form-control"
                     placeholder="Search by product name...">
            </div>

            <div class="col-md-4">
              <label for="productSort" class="form-label small text-muted mb-1">Sort by</label>
              <select id="productSort" class="form-select">
                <option value="">None</option>
                <option value="name-asc">Name A–Z</option>
                <option value="name-desc">Name Z–A</option>
                <option value="price-asc">Price (low → high)</option>
                <option value="price-desc">Price (high → low)</option>
                <option value="qty-asc">Quantity (low → high)</option>
                <option value="qty-desc">Quantity (high → low)</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Product grid -->
      <% if (!products || products.length === 0) { %>
        <div class="card shadow-sm">
          <div class="card-body text-center">
            <p class="mb-1">No products available in the database.</p>
            <a href="/addProduct" class="btn btn-primary btn-sm mt-2">Add your first product</a>
          </div>
        </div>
      <% } else { %>
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-3"
                 id="productGrid">
              <% for (let i = 0; i < products.length; i++) { %>
                <div class="col">
                  <div class="card h-100 product-card"
                       data-name="<%= products[i].productName.toLowerCase() %>"
                       data-price="<%= products[i].price %>"
                       data-qty="<%= products[i].quantity %>">
                    <img src="/images/<%= products[i].image %>"
                         alt="Product image"
                         class="card-img-top product-card-img">

                    <div class="card-body d-flex flex-column">
                      <h5 class="card-title mb-1"><%= products[i].productName %></h5>
                      <p class="card-text mb-1 text-muted small">
                        Quantity: <strong><%= products[i].quantity %></strong>
                      </p>
                      <p class="card-text mb-3 product-card-price">
                        $<%= products[i].price.toFixed(2) %>
                      </p>

                      <div class="mt-auto d-flex justify-content-between">
                        <a class="btn btn-sm btn-outline-primary"
                           href="/updateProduct/<%= products[i].id %>">
                          Edit
                        </a>
                        <form method="POST"
                              action="/deleteProduct/<%= products[i].id %>"
                              onsubmit="return confirm('Are you sure you want to delete this product?');"
                              class="d-inline">
                          <button type="submit" class="btn btn-sm btn-outline-danger">
                            Delete
                          </button>
                        </form>
                      </div>
                    </div>
                  </div>
                </div>
              <% } %>
            </div>
          </div>
        </div>
      <% } %>
    </div>
  </main>

  <script>
    (function () {
      const searchInput = document.getElementById('productSearch');
      const sortSelect  = document.getElementById('productSort');
      const grid        = document.getElementById('productGrid');
      if (!grid) return;

      const cards = Array.from(grid.querySelectorAll('.product-card'));

      function applyFilter() {
        const term = (searchInput && searchInput.value || '').toLowerCase();

        cards.forEach(card => {
          const name = card.dataset.name || '';
          const match = !term || name.includes(term);
          card.parentElement.style.display = match ? '' : 'none'; // hide the column
        });
      }

      function applySort() {
        const value = sortSelect ? sortSelect.value : '';
        if (!value) return;

        const [field, dir] = value.split('-'); // name-asc, price-desc, qty-asc

        const visibleCols = cards
          .filter(card => card.parentElement.style.display !== 'none')
          .map(card => card.parentElement); // .col elements

        visibleCols.sort((aCol, bCol) => {
          const a = aCol.querySelector('.product-card');
          const b = bCol.querySelector('.product-card');
          let av, bv;

          if (field === 'name') {
            av = (a.dataset.name || '').toLowerCase();
            bv = (b.dataset.name || '').toLowerCase();
          } else if (field === 'price') {
            av = parseFloat(a.dataset.price || '0');
            bv = parseFloat(b.dataset.price || '0');
          } else if (field === 'qty') {
            av = parseInt(a.dataset.qty || '0', 10);
            bv = parseInt(b.dataset.qty || '0', 10);
          } else {
            return 0;
          }

          if (av < bv) return dir === 'asc' ? -1 : 1;
          if (av > bv) return dir === 'asc' ? 1 : -1;
          return 0;
        });

        visibleCols.forEach(col => grid.appendChild(col));
      }

      if (searchInput) {
        searchInput.addEventListener('input', () => {
          applyFilter();
          applySort(); // keep sort after filtering
        });
      }

      if (sortSelect) {
        sortSelect.addEventListener('change', () => {
          applySort();
        });
      }
    })();
  </script>
</body>
</html>
