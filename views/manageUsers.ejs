<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title><%= title || 'Users' %></title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Bootstrap + app.css -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/app.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="bg-page">
  <%- include('partials/admin-modern-navbar', { user: user, active: 'users' }) %>

  <main class="app-main">
    <div class="container-fluid">

      <!-- Header row -->
      <div class="row align-items-center mb-3">
        <div class="col-md-6">
          <h2 class="mb-1">Users</h2>
          <p class="text-muted mb-0">
            Manage admin and customer accounts for the supermarket.
          </p>
        </div>
        <div class="col-md-6 text-md-end mt-3 mt-md-0">
          <a class="btn btn-primary me-2" href="/admin/users/new">+ New User</a>
          <a class="btn btn-outline-secondary" href="/">Back to Home</a>
        </div>
      </div>

      <!-- Flash messages -->
      <% if (error && error.length) { %>
        <div class="alert alert-danger"><%= error[0] %></div>
      <% } %>
      <% if (success && success.length) { %>
        <div class="alert alert-success"><%= success[0] %></div>
      <% } %>

      <!-- Filters & sort card -->
      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <div class="row g-2">
            <div class="col-md-4">
              <label for="userSearch" class="form-label small text-muted mb-1">Search</label>
              <input id="userSearch" type="text" class="form-control"
                     placeholder="Search by username or email...">
            </div>

            <div class="col-md-3">
              <label for="userRoleFilter" class="form-label small text-muted mb-1">Role</label>
              <select id="userRoleFilter" class="form-select">
                <option value="">All roles</option>
                <option value="admin">Admin</option>
                <option value="user">User</option>
              </select>
            </div>

            <div class="col-md-3">
              <label for="userSort" class="form-label small text-muted mb-1">Sort by</label>
              <select id="userSort" class="form-select">
                <option value="">None</option>
                <option value="name-asc">Name A–Z</option>
                <option value="name-desc">Name Z–A</option>
                <option value="id-asc">ID (oldest → newest)</option>
                <option value="id-desc">ID (newest → oldest)</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Users table card -->
      <div class="card shadow-sm">
        <div class="card-body">
          <% if (!users || users.length === 0) { %>
            <p class="mb-0 text-center">No users found.</p>
          <% } else { %>
            <div class="table-responsive">
              <table class="table table-striped table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th>ID</th>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Address</th>
                    <th>Contact</th>
                    <th>Role</th>
                    <th class="text-end">Actions</th>
                  </tr>
                </thead>
                <tbody id="userTableBody">
                  <% (users || []).forEach(u => { %>
                    <tr class="user-row"
                        data-id="<%= u.id %>"
                        data-name="<%= (u.username || '').toLowerCase() %>"
                        data-email="<%= (u.email || '').toLowerCase() %>"
                        data-role="<%= u.role %>">
                      <td><%= u.id %></td>
                      <td><%= u.username %></td>
                      <td><%= u.email %></td>
                      <td><%= u.address %></td>
                      <td><%= u.contact %></td>
                      <td>
                        <span class="badge <%= u.role === 'admin' ? 'bg-danger' : 'bg-secondary' %>">
                          <%= u.role %>
                        </span>
                      </td>
                      <td class="text-end">
                        <a class="btn btn-sm btn-outline-primary"
                           href="/admin/users/<%= u.id %>/edit">Edit</a>
                        <form method="POST"
                              action="/admin/users/<%= u.id %>/delete"
                              class="d-inline"
                              onsubmit="return confirm('Delete this user?');">
                          <button class="btn btn-sm btn-outline-danger" type="submit">
                            Delete
                          </button>
                        </form>
                      </td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          <% } %>
        </div>
      </div>
    </div>
  </main>

  <script>
    (function () {
      const searchInput = document.getElementById('userSearch');
      const roleSelect  = document.getElementById('userRoleFilter');
      const sortSelect  = document.getElementById('userSort');
      const tbody       = document.getElementById('userTableBody');
      if (!tbody) return;

      const rows = Array.from(tbody.querySelectorAll('.user-row'));

      function visibleRows() {
        return rows.filter(r => r.style.display !== 'none');
      }

      function applyFilter() {
        const term = (searchInput && searchInput.value || '').toLowerCase();
        const role = roleSelect ? roleSelect.value : '';

        rows.forEach(row => {
          const name  = row.dataset.name || '';
          const email = row.dataset.email || '';
          const r     = row.dataset.role || '';

          const matchText = !term || name.includes(term) || email.includes(term);
          const matchRole = !role || r === role;

          row.style.display = (matchText && matchRole) ? '' : 'none';
        });
      }

      function applySort() {
        const value = sortSelect ? sortSelect.value : '';
        if (!value) return;

        const [key, dir] = value.split('-'); // name-asc, id-desc
        const rowsToSort = visibleRows();

        rowsToSort.sort((a, b) => {
          let av, bv;
          if (key === 'name') {
            av = a.dataset.name || '';
            bv = b.dataset.name || '';
          } else if (key === 'id') {
            av = parseInt(a.dataset.id || '0', 10);
            bv = parseInt(b.dataset.id || '0', 10);
          } else {
            return 0;
          }

          if (av < bv) return dir === 'asc' ? -1 : 1;
          if (av > bv) return dir === 'asc' ? 1 : -1;
          return 0;
        });

        rowsToSort.forEach(row => tbody.appendChild(row));
      }

      if (searchInput) {
        searchInput.addEventListener('input', applyFilter);
      }
      if (roleSelect) {
        roleSelect.addEventListener('change', applyFilter);
      }
      if (sortSelect) {
        sortSelect.addEventListener('change', () => {
          applySort();
        });
      }
    })();
  </script>
</body>
</html>
