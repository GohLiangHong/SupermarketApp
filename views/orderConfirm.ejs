<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Order Confirmation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="/css/app.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f4f4f4; }
    .summary-card { background:#fff; border-radius:8px; box-shadow:0 0 8px rgba(0,0,0,0.08); padding:20px; }
    .pay-card { background:#fff; border-radius:8px; padding:20px; box-shadow:0 0 6px rgba(0,0,0,0.04); }
    .method-logo { height:28px; margin-right:8px; vertical-align:middle; }
    .small-muted { font-size:.9rem; color:#6c757d; }
  </style>
</head>
<body>
  <%- include('partials/navbar', { active: 'orders' }) %>

  <div class="container mt-4">
    <% 
      // compute subtotal from items to avoid relying on possibly incorrect order.subtotal
      const computedSubtotal = (order && order.items && order.items.length)
        ? order.items.reduce((s, it) => {
            const itemSubtotal = parseFloat(it.subtotal) || (parseFloat(it.unit_price || 0) * Number(it.quantity || 0));
            return s + itemSubtotal;
          }, 0)
        : 0;
    %>
    <% if (error && error.length) { %><div class="alert alert-danger"><%= error[0] %></div><% } %>
    <% if (success && success.length) { %><div class="alert alert-success"><%= success[0] %></div><% } %>

    <div class="row g-4">
      <!-- Left: Order summary -->
      <div class="col-lg-8">
        <div class="summary-card">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <h4 class="mb-0">Order #<%= order.id %></h4>
              <div class="small-muted">Ref: <%= order.referenceId %> â€¢ Status: <%= order.status %></div>
            </div>
            <div class="text-end">
              <div class="small-muted">Order date</div>
              <div><%= order.createOn ? new Date(order.createOn).toLocaleString() : '' %></div>
            </div>
          </div>

          <hr>

          <h6>Items</h6>
          <div class="table-responsive">
            <table class="table table-borderless align-middle mb-0">
              <thead class="visually-hidden">
                <tr><th>Product</th><th>Qty</th><th class="text-end">Unit</th><th class="text-end">Subtotal</th></tr>
              </thead>
              <tbody>
                <% if (!order.items || !order.items.length) { %>
                  <tr><td colspan="4" class="small-muted">No items found for this order.</td></tr>
                <% } else { %>
                  <% order.items.forEach(function(it){ %>
                    <tr>
                      <td><strong><%= it.product_name %></strong><div class="small-muted"><%= it.productID %></div></td>
                      <td class="text-center"><%= it.quantity %></td>
                      <td class="text-end">$<%= parseFloat(it.unit_price).toFixed(2) %></td>
                      <td class="text-end">$<%= parseFloat(it.subtotal).toFixed(2) %></td>
                    </tr>
                  <% }); %>
                <% } %>
              </tbody>
            </table>
          </div>

          <hr>

          <div class="row">
            <div class="col-sm-6 small-muted">
              <div>Shipping to:</div>
              <div><%= order.customer?.username || '' %></div>
              <div class="small-muted"><%= order.customer?.address || '' %></div>
              <div class="small-muted">Contact: <%= order.customer?.contact || order.customer?.email || '' %></div>
            </div>
            <div class="col-sm-6">
              <div class="d-flex justify-content-between small-muted">
                <div>Subtotal</div>
                <div>$<%= computedSubtotal.toFixed(2) %></div>
              </div>
              <div class="d-flex justify-content-between small-muted">
                <div>Tax</div>
                <div>$<%= parseFloat(order.tax || 0).toFixed(2) %></div>
              </div>
              <div class="d-flex justify-content-between small-muted">
                <div>Shipping</div>
                <div>$<%= parseFloat(order.shipping_fee || 0).toFixed(2) %></div>
              </div>
              <div class="d-flex justify-content-between small-muted">
                <div>Discount</div>
                <div>-$<%= parseFloat(order.discount || 0).toFixed(2) %></div>
              </div>
              <hr>
              <div class="d-flex justify-content-between fs-5 fw-bold">
                <div>Total</div>
                <div>$<%= parseFloat(order.total || 0).toFixed(2) %></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right: Payment methods & actions -->
      <div class="col-lg-4">
        <div class="pay-card">
          <h5 class="mb-3">Payment</h5>

          <form id="paymentSelector" class="mb-3" onsubmit="return false;">
            <div class="list-group">
              <label class="list-group-item d-flex align-items-center">
                <input class="form-check-input me-2" type="radio" name="paymentMethod" value="PAYPAL">
                <img src="/images/paypal.png" alt="PayPal" class="method-logo"> PayPal
              </label>

              <label class="list-group-item d-flex align-items-center">
                <input class="form-check-input me-2" type="radio" name="paymentMethod" value="NETS">
                <img src="/images/nets.png" alt="NETS" class="method-logo"> NETS
              </label>
              <label class="list-group-item d-flex align-items-center">
                <input class="form-check-input me-2" type="radio" name="paymentMethod" value="STRIPE">
                <img src="/images/stripe.png" alt="Stripe" class="method-logo"> Stripe
              </label>

              <label class="list-group-item d-flex align-items-center">
                <input class="form-check-input me-2" type="radio" name="paymentMethod" value="EWALLET">
                <img src="/images/ewallet.png" alt="E-Wallet" class="method-logo"> E-Wallet
              </label>

            </div>
          </form>

          <div class="mt-3">
            <button id="proceedBtn" type="button" class="btn btn-success w-100 mb-2">Proceed to payment</button>
            <button id="editCartBtn" type="button" class="btn btn-outline-secondary w-100 mb-2">Edit Cart</button>
          </div>

          <div class="mt-3 small-muted text-center">
            By continuing you agree to our <a href="/terms">Terms</a> and <a href="/privacy">Privacy</a>.
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    (function(){
      const proceedBtn = document.getElementById('proceedBtn');
      const editCartBtn = document.getElementById('editCartBtn');

      function showInlineError(msg) {
        let el = document.getElementById('ewalletErrorAlert');
        if (!el) {
          el = document.createElement('div');
          el.id = 'ewalletErrorAlert';
          el.className = 'alert alert-danger mt-3';
          const container = document.querySelector('.container') || document.body;
          container.insertBefore(el, container.firstChild);
        }
        el.textContent = msg;
        el.scrollIntoView({ behavior: 'smooth' });
      }

      proceedBtn.addEventListener('click', function(){
        const selected = document.querySelector('input[name="paymentMethod"]:checked');
        if (!selected) { alert('Please select a payment method.'); return; }

        const method = selected.value;
        const orderId = '<%= order.id %>';

        if (method === 'PAYPAL') {
          window.location.href = '/payments/paypal?orderId=' + encodeURIComponent(orderId);
        } else if (method === 'NETS') {
          window.location.href = '/payments/nets?orderId=' + encodeURIComponent(orderId);} 
          else if (method === 'STRIPE') {
          window.location.href = '/payments/stripe?orderId=' + encodeURIComponent(orderId);

        } else if (method === 'EWALLET') {
          // new: check server-side wallet balance before redirecting
          fetch('/api/wallet/balance', { credentials: 'same-origin' })
            .then(r => {
              if (!r.ok) throw r;
              return r.json();
            })
            .then(data => {
              const balance = Number(data.balance || 0);
              const total = Number(<%= parseFloat(order.total || 0).toFixed(2) %>);
              if (balance + 1e-9 < total) {
                showInlineError('Insufficient e-wallet balance. Please top up or choose another payment method.');
                return;
              }
              // enough balance -> proceed
              window.location.href = '/payments/ewallet?orderId=' + encodeURIComponent(orderId);
            })
            .catch(() => {
              showInlineError('Unable to verify wallet balance right now. Please try again.');
            });
        } else {
          alert('Please select a valid payment method.');
        }
      });

      if (editCartBtn) {
        editCartBtn.addEventListener('click', function () {
          try {
            if (document.referrer && document.referrer.includes('/cart')) {
              window.location.href = document.referrer;
              return;
            }
          } catch (e) {}
          if (history.length > 1) { history.back(); return; }
          window.location.href = '/cart';
        });
      }
    })();
  </script>

</body>
</html>
