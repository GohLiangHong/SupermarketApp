<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Orders</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="/css/app.css" rel="stylesheet">
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
</head>
<body>
  <%- include('partials/navbar', { active: 'orders' }) %>
    <!-- rest of your order history -->

  <div class="container mt-4">
    <% if (user) { %>
      <p>Welcome, <%= user.email %> (<%= user.role %>)</p>
    <% } %>

    <h2>My Orders</h2>

    <% if (error && error.length) { %>
      <div class="alert alert-danger"><%= error[0] %></div>
    <% } %>
    <% if (success && success.length) { %>
      <div class="alert alert-success"><%= success[0] %></div>
    <% } %>

    <% if (!orders || !orders.length) { %>
      <div class="alert alert-info mt-3">
        You have not placed any orders yet.
      </div>
    <% } else { %>

      <!-- Search / Filter / Sort -->
      <div class="row mb-3">
        <div class="col-md-4 mb-2">
          <input id="orderSearch" type="text" class="form-control" placeholder="Search by reference no. or status...">
        </div>
        <div class="col-md-3 mb-2">
          <select id="orderStatusFilter" class="form-select">
            <option value="">All status</option>
            <option value="PENDING">PENDING</option>
            <option value="PAID">PAID</option>
            <option value="CANCELLED">CANCELLED</option>
          </select>
        </div>
        <div class="col-md-3 mb-2">
          <select id="orderSort" class="form-select">
            <option value="">Sort...</option>
            <option value="total-asc">Total (low → high)</option>
            <option value="total-desc">Total (high → low)</option>
            <option value="id-asc">Order ID (oldest → newest)</option>
            <option value="id-desc">Order ID (newest → oldest)</option>
          </select>
        </div>
      </div>

      <table class="table table-hover table-sm mt-3 align-middle text-center">
        <thead class="table-light">
          <tr>
            <th scope="col">Reference No.</th>
            <th scope="col">Date</th>
            <th scope="col">Status</th>
            <th scope="col">Payment</th>
            <th scope="col">Total</th>
            <th scope="col">Action</th>
          </tr>
        </thead>
        <tbody id="orderTableBody">
          <% orders.forEach(function(order) { %>
            <tr class="order-row"
                data-id="<%= order.id %>"
                data-ref="<%= (order.referenceId || '').toLowerCase() %>"
                data-status="<%= order.status %>"
                data-total="<%= order.total %>">
              <% const isPending = (order.status === 'PENDING'); %>

              <td>
                <!-- If status is PENDING, go to confirmation page, else go to detail/receipt -->
                <a href="<%= isPending ? ('/orders/confirm/' + order.id) : ('/orders/' + order.id) %>">
                  <%= order.referenceId %>
                </a>
              </td>

              <td>
                <% if (order.createOn) { %>
                  <%= new Date(order.createOn).toLocaleString() %>
                <% } %>
              </td>

              <td>
                <span class="badge bg-secondary"><%= order.status %></span>
              </td>

              <td><%= order.paymentMode %></td>
              <td>$<%= Number(order.total).toFixed(2) %></td>

              <td>
                <a
                  href="<%= isPending ? ('/orders/confirm/' + order.id) : ('/orders/' + order.id) %>"
                  class="btn btn-sm btn-primary"
                >
                  <%= isPending ? 'Confirm' : 'View' %>
                </a>
              </td>
            </tr>
          <% }); %>
        </tbody>

      </table>
    <% } %>
  </div>

  <script>
  (function() {
    const searchInput = document.getElementById('orderSearch');
    const statusSelect = document.getElementById('orderStatusFilter');
    const sortSelect   = document.getElementById('orderSort');
    const tbody        = document.getElementById('orderTableBody');
    if (!tbody) return;

    const rows = Array.from(tbody.querySelectorAll('.order-row'));

    function applyFilter() {
      const term   = (searchInput?.value || '').toLowerCase();
      const status = statusSelect?.value || '';

      rows.forEach(row => {
        const ref = row.dataset.ref || '';
        const s   = row.dataset.status || '';
        const matchText   = !term || ref.includes(term) || s.toLowerCase().includes(term);
        const matchStatus = !status || s === status;
        row.style.display = (matchText && matchStatus) ? '' : 'none';
      });
    }

    function applySort() {
      const value = sortSelect?.value;
      if (!value) return;

      const [key, dir] = value.split('-');
      const visible = rows.filter(r => r.style.display !== 'none');

      visible.sort((a, b) => {
        let av = key === 'id'
          ? parseInt(a.dataset.id, 10)
          : parseFloat(a.dataset.total);
        let bv = key === 'id'
          ? parseInt(b.dataset.id, 10)
          : parseFloat(b.dataset.total);

        if (av < bv) return dir === 'asc' ? -1 : 1;
        if (av > bv) return dir === 'asc' ? 1 : -1;
        return 0;
      });

      visible.forEach(r => tbody.appendChild(r));
    }

    if (searchInput) {
      searchInput.addEventListener('input', applyFilter);
    }
    if (statusSelect) {
      statusSelect.addEventListener('change', applyFilter);
    }
    if (sortSelect) {
      sortSelect.addEventListener('change', applySort);
    }
  })();
  </script>
</body>
</html>
