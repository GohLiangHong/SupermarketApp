<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Payment</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="/css/app.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- PayPal JS SDK (debug=true helps surface errors in DevTools Console) -->
  <script src="https://www.paypal.com/sdk/js?client-id=<%= paypalClientId %>&currency=SGD&intent=capture&debug=true"></script>
</head>
<body>
  <%- include('partials/navbar', { active: 'orders' }) %>

  <main class="container my-4">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4 class="mb-0">Payment for Order <span class="text-muted">#<%= order.referenceId %></span></h4>
          <div class="text-end">
            <div class="fw-semibold">Total: $<%= parseFloat(order.total || 0).toFixed(2) %></div>
            <div class="muted" style="font-size:0.85rem;"><%= order.currency || 'SGD' %></div>
          </div>
        </div>

        <div class="row">
          <div class="col-lg-8">
            <div class="table-responsive mb-3">
              <table class="table table-striped align-middle">
                <thead class="table-light">
                  <tr>
                    <th>Product</th>
                    <th class="text-end" style="width:120px;">Unit Price</th>
                    <th class="text-end" style="width:80px;">Qty</th>
                    <th class="text-end" style="width:140px;">Subtotal</th>
                  </tr>
                </thead>
                <tbody>
                  <% if (order.items && order.items.length) { %>
                    <% order.items.forEach(it => { %>
                      <tr>
                        <td>
                          <div class="fw-semibold"><%= it.product_name %></div>
                          <div class="text-muted" style="font-size:0.85rem;">ID: <%= it.productID %></div>
                        </td>
                        <td class="text-end">$<%= parseFloat(it.unit_price).toFixed(2) %></td>
                        <td class="text-end"><%= it.quantity %></td>
                        <td class="text-end fw-semibold">$<%= parseFloat(it.subtotal).toFixed(2) %></td>
                      </tr>
                    <% }) %>
                  <% } else { %>
                    <tr><td colspan="4" class="text-center text-muted">No items found</td></tr>
                  <% } %>
                </tbody>
              </table>
            </div>
          </div>

          <div class="col-lg-4">
            <div class="border rounded p-3 bg-light">
              <div class="mb-2 section-title">Order Summary</div>
              <div class="d-flex justify-content-between mb-2"><div class="muted">Subtotal</div><div>$<%= parseFloat(order.subtotal||0).toFixed(2) %></div></div>
              <div class="d-flex justify-content-between mb-2"><div class="muted">Shipping</div><div>$<%= parseFloat(order.shipping_fee||0).toFixed(2) %></div></div>
              <div class="d-flex justify-content-between mb-2"><div class="muted">Discount</div><div>-$<%= parseFloat(order.discount||0).toFixed(2) %></div></div>
              <div class="d-flex justify-content-between mb-2"><div class="muted">Tax</div><div>$<%= parseFloat(order.tax||0).toFixed(2) %></div></div>
              <hr>
              <div class="d-flex justify-content-between align-items-end">
                <div class="section-title">Total</div>
                <div class="order-total text-danger">$<%= parseFloat(order.total||0).toFixed(2) %></div>
              </div>
              <div class="muted mt-2" style="font-size:0.85rem;">You will be redirected to PayPal to complete payment.</div>
            </div>
          </div>
        </div>

        <div class="mt-4">
          <div id="paypal-button-container"></div>
          <div id="pay-msg" class="text-muted mt-2" style="display:none;">Processing paymentâ€¦</div>
        </div>

      </div>
    </div>
  </main>

  <%- include('partials/footer') %>

  <script>
    (function () {
      const orderId = <%- JSON.stringify(order && order.id ? order.id : null) %>;
      const total = '<%= parseFloat(order.total||0).toFixed(2) %>';

      if (!orderId) {
        document.getElementById('paypal-button-container').innerText = 'Invalid order.';
        return;
      }

      try {
        paypal.Buttons({
          createOrder: function () {
            return fetch('/api/paypal/create-order', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ orderId })
            })
              .then(res => res.json())
              .then(data => {
                if (data && data.id) return data.id;
                throw new Error((data && data.error) ? data.error : 'Failed to create PayPal order');
              });
          },
          onApprove: function (data) {
            document.getElementById('pay-msg').style.display = 'block';
            return fetch('/api/paypal/capture-order', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ orderId, orderID: data.orderID })
            })
              .then(res => res.json())
              .then(result => {
                if (result && (result.success || result.status === 'COMPLETED')) {
                  window.location.href = '/orders/' + orderId;
                } else {
                  alert((result && result.error) ? result.error : 'Payment not completed.');
                  document.getElementById('pay-msg').style.display = 'none';
                }
              })
              .catch(err => {
                console.error(err);
                alert('Payment failed. Please try again.');
                document.getElementById('pay-msg').style.display = 'none';
              });
          },
          onCancel: function () {
            alert('Payment cancelled. Your order is still pending.');
          },
          onError: function (err) {
            console.error('PayPal error', err);
            alert('PayPal error occurred. Please try again.');
          }
        }).render('#paypal-button-container');
      } catch (e) {
        console.error('PayPal Buttons render error:', e);
      }
    })();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
