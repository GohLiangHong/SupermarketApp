<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Wallet Top Up</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <link href="/css/app.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- PayPal JS SDK -->
  <script src="https://www.paypal.com/sdk/js?client-id=<%= paypalClientId %>&currency=SGD&intent=capture&debug=true"></script>
</head>

<body class="bg-page">
  <%- include('partials/navbar', { active: 'wallet' }) %>

  <main class="container app-main">
    <div class="row justify-content-center">
      <div class="col-lg-7">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <h4 class="mb-1">Confirm Wallet Top Up</h4>
                <div class="text-muted">You are topping up your E-Wallet.</div>
              </div>
              <span class="badge bg-primary">E-Wallet</span>
            </div>

            <% if (error && error.length) { %>
              <div class="alert alert-danger mt-3 mb-0"><%= error[0] %></div>
            <% } %>
            <% if (success && success.length) { %>
              <div class="alert alert-success mt-3 mb-0"><%= success[0] %></div>
            <% } %>

            <hr class="my-3">

            <div class="border rounded p-3 bg-light">
              <div class="d-flex justify-content-between mb-2">
                <div class="fw-semibold">Top Up Amount</div>
                <div class="fw-bold text-danger">$<%= Number(amount || 0).toFixed(2) %></div>
              </div>
              <div class="d-flex justify-content-between">
                <div class="text-muted">Transaction ID</div>
                <div class="text-muted">#<%= txId %></div>
              </div>
            </div>

            <div class="mt-4">
              <div id="paypal-button-container"></div>
              <div id="pay-msg" class="text-muted mt-2" style="display:none;">Processing paymentâ€¦</div>
            </div>

            <div class="mt-3">
              <a class="btn btn-outline-secondary w-100" href="/wallet">Cancel</a>
            </div>

          </div>
        </div>
      </div>
    </div>
  </main>

  <%- include('partials/footer') %>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    (function () {
      const txId = <%- JSON.stringify(txId || null) %>;

      if (!txId) {
        document.getElementById('paypal-button-container').innerText = 'Invalid top up transaction.';
        return;
      }

      try {
        paypal.Buttons({
          createOrder: function () {
            // server creates order based on txId (server = source of truth)
            return fetch('/api/paypal/wallet/create-order', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ txId })
            })
              .then(res => res.json())
              .then(data => {
                if (data && data.id) return data.id;
                throw new Error((data && data.error) ? data.error : 'Failed to create PayPal order');
              });
          },

          onApprove: function (data) {
            document.getElementById('pay-msg').style.display = 'block';

            return fetch('/api/paypal/wallet/capture-order', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ orderID: data.orderID, txId })
            })
              .then(res => res.json())
              .then(result => {
                if (result && (result.success || result.status === 'COMPLETED')) {
                  window.location.href = '/wallet';
                } else {
                  alert((result && result.error) ? result.error : 'Top up not completed.');
                  document.getElementById('pay-msg').style.display = 'none';
                }
              })
              .catch(err => {
                console.error(err);
                alert('Top up failed. Please try again.');
                document.getElementById('pay-msg').style.display = 'none';
              });
          },

          onCancel: function () {
            alert('Payment cancelled.');
          },

          onError: function (err) {
            console.error('PayPal error', err);
            alert('PayPal error occurred. Please try again.');
          }
        }).render('#paypal-button-container');
      } catch (e) {
        console.error('PayPal Buttons render error:', e);
      }
    })();
  </script>
</body>
</html>
