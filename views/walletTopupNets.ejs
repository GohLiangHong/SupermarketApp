<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NETS Wallet Top Up</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="/css/app.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- NETS SSE polyfill (same as NetsPayment.ejs) -->
  <script src="https://unpkg.com/event-source-polyfill"></script>

  <style>
    .app-navbar {
      background: linear-gradient(to bottom, #0b4f8a, #083b6f);
    }
  </style>
</head>

<body class="bg-page">
  <%- include('partials/navbar', { active: 'wallet', user: user }) %>

  <main class="container my-4">
    <div class="row justify-content-center">
      <div class="col-lg-7">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <h4 class="mb-1">Scan NETS QR to Top Up</h4>
                <div class="text-muted">Top up amount: <span class="fw-semibold">$<%= Number(amount || 0).toFixed(2) %></span></div>
                <div class="text-muted" style="font-size:0.9rem;">Transaction ID: #<%= txId %></div>
              </div>
              <span class="badge bg-primary">NETS</span>
            </div>

            <% if (error && error.length) { %>
              <div class="alert alert-danger mt-3 mb-0"><%= error[0] %></div>
            <% } %>
            <% if (success && success.length) { %>
              <div class="alert alert-success mt-3 mb-0"><%= success[0] %></div>
            <% } %>

            <hr class="my-3">

            <p id="status" class="text-muted mb-3">
              Scan with your bank app / T-wallet to complete payment.
            </p>

            <% if (qrCodeUrl && qrCodeUrl.length) { %>
              <div class="text-center">
                <img
                  src="<%= qrCodeUrl %>"
                  alt="NETS QR Code"
                  class="img-fluid border rounded p-3 bg-white"
                  style="max-width:360px;"
                />
              </div>
            <% } else { %>
              <p class="text-danger">QR code not available. Please try again.</p>
            <% } %>

            <p id="timer" class="mt-3 fw-semibold text-center">
              Time remaining: 5:00
            </p>

            <div class="mt-3 d-grid gap-2">
              <a class="btn btn-outline-secondary" href="/wallet">Back to Wallet</a>
              <a class="btn btn-outline-danger" href="/wallet/nets/fail?txn=<%= encodeURIComponent(txnRetrievalRef) %>">Cancel</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <%- include('partials/footer') %>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    let s2sNetsTxnStatus;

    if (s2sNetsTxnStatus) {
      s2sNetsTxnStatus.close();
    }

    const txnRetrievalRef = "<%= txnRetrievalRef %>";
    const url = `/sse/nets/payment-status/${txnRetrievalRef}`;

    s2sNetsTxnStatus = new EventSourcePolyfill(url, {
      heartbeatTimeout: 150000,
    });

    s2sNetsTxnStatus.addEventListener("message", (event) => {
      const data = JSON.parse(event.data);
      console.log("NETS Query Response:", data);

      if (data.success) {
        if (s2sNetsTxnStatus) s2sNetsTxnStatus.close();
        window.location.href = `/wallet/nets/success?txn=${encodeURIComponent(txnRetrievalRef)}`;
      } else if (data.fail) {
        if (s2sNetsTxnStatus) s2sNetsTxnStatus.close();
        window.location.href = `/wallet/nets/fail?txn=${encodeURIComponent(txnRetrievalRef)}`;
      }
    });

    const timerElement = document.getElementById("timer");
    let remainingTime = 300;

    const updateTimer = () => {
      const minutes = Math.floor(remainingTime / 60);
      const seconds = remainingTime % 60;
      timerElement.textContent = `Time remaining: ${minutes}:${seconds.toString().padStart(2, "0")}`;
      remainingTime--;

      if (remainingTime < 0) {
        clearInterval(timerInterval);
        timerElement.textContent = "Transaction timed out.";

        if (s2sNetsTxnStatus) {
          s2sNetsTxnStatus.close();
        }
        window.location.href = `/wallet/nets/fail?txn=${encodeURIComponent(txnRetrievalRef)}`;
      }
    };

    const timerInterval = setInterval(updateTimer, 1000);
    updateTimer();
  </script>
</body>
</html>
